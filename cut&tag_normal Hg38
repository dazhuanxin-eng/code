# ======= ç¯å¢ƒè®¾ç½® =======
unset LD_LIBRARY_PATH
module load bowtie2
module load samtools
module load deeptools/3.5.5

# ======= åŸºç¡€è·¯å¾„ =======
BASE_DIR=/data/RichardLuLab/Eric/MTORCUTTAG
OUT_DIR=${BASE_DIR}/results
REF_INDEX=/data/tianlab/Eric/botiwe2genome/grch38_1kgmaj_snvs/grch38_1kgmaj_snvs    # normal Hg38 index
mkdir -p ${OUT_DIR}

# ======= æ ·æœ¬å¾ªç¯ =======
for SAMPLE in A13 A14 A15 K1N K2N K3N K4N K5N
do
    echo "ğŸ§¬ Processing sample: ${SAMPLE}"
    cd ${BASE_DIR}/${SAMPLE}

    # è‡ªåŠ¨åŒ¹é…fqæ–‡ä»¶å
    R1=$(ls *_1.fq.gz 2>/dev/null | head -n 1)
    R2=$(ls *_2.fq.gz 2>/dev/null | head -n 1)

    if [[ -z "$R1" || -z "$R2" ]]; then
        echo "âŒ Missing FASTQ files for ${SAMPLE}, skipping..."
        continue
    fi

    echo "Using R1=${R1}, R2=${R2}"

    # ======= è¿è¡Œæ¯”å¯¹ =======
    bowtie2 -p 10 -x ${REF_INDEX} \
        -1 ${R1} -2 ${R2} \
        -S ${SAMPLE}.sam

    # ======= è½¬æ¢å¹¶æ’åº =======
    samtools view -S -b ${SAMPLE}.sam > ${SAMPLE}.bam
    samtools sort ${SAMPLE}.bam -o ${SAMPLE}.sorted.bam
    samtools index ${SAMPLE}.sorted.bam
    rm ${SAMPLE}.sam ${SAMPLE}.bam  # èŠ‚çœç©ºé—´

    # ======= ç”Ÿæˆbigwig (not run) =======
    bamCoverage -b ${SAMPLE}.sorted.bam -o ${OUT_DIR}/${SAMPLE}.bw \
        --normalizeUsing CPM --binSize 10 --extendReads 200

    echo "âœ… Finished ${SAMPLE}"
done

echo "ğŸ‰ All samples processed successfully!"
########################################
unset LD_LIBRARY_PATH
module load samtools
module load deeptools/3.5.5

# ======== è·¯å¾„ ==========
BASE_DIR=/data/RichardLuLab/Eric/MTORCUTTAG
OUT_DIR=${BASE_DIR}/bw_RPGC
mkdir -p ${OUT_DIR}

# ======== æ ·æœ¬åˆ—è¡¨ï¼ˆå¯æ”¹ï¼‰==========
for SAMPLE in A13 A14 A15 K1N K2N K3N K4N K5N
do
    BAM=${BASE_DIR}/${SAMPLE}/${SAMPLE}.hg38.sorted.bam
    BW=${OUT_DIR}/${SAMPLE}.RPGC.bw

    if [ ! -s $BAM ]; then
        echo "âŒ Missing BAM for ${SAMPLE}, skipping..."
        continue
    fi

    echo "ğŸš€ Generating RPGC bigWig for ${SAMPLE}..."

    bamCoverage \
        -b $BAM \
        -o $BW \
        --binSize 10 \
        --normalizeUsing RPGC \
        --effectiveGenomeSize 2913022398 \
        --ignoreForNormalization chrX \
        --extendReads \
        --numberOfProcessors 8 \
        --verbose

    if [ -s $BW ]; then
        echo "âœ… Finished: ${BW}"
    else
        echo "âš ï¸ Failed for ${SAMPLE}, check log"
    fi
done

echo "ğŸ‰ All RPGC-normalized bigWigs generated!"



