# ======= ÁéØÂ¢ÉËÆæÁΩÆ =======
unset LD_LIBRARY_PATH
module load bowtie2
module load samtools
module load deeptools/3.5.5

# ======= Âü∫Á°ÄË∑ØÂæÑ =======
BASE_DIR=/data/RichardLuLab/Eric/MTORCUTTAG
OUT_DIR=${BASE_DIR}/results
REF_INDEX=/data/tianlab/Eric/botiwe2genome/grch38_1kgmaj_snvs/grch38_1kgmaj_snvs    # normal Hg38 index
mkdir -p ${OUT_DIR}

# ======= Ê†∑Êú¨Âæ™ÁéØ =======
for SAMPLE in A13 A14 A15 K1N K2N K3N K4N K5N
do
    echo "üß¨ Processing sample: ${SAMPLE}"
    cd ${BASE_DIR}/${SAMPLE}

    # Ëá™Âä®ÂåπÈÖçfqÊñá‰ª∂Âêç
    R1=$(ls *_1.fq.gz 2>/dev/null | head -n 1)
    R2=$(ls *_2.fq.gz 2>/dev/null | head -n 1)

    if [[ -z "$R1" || -z "$R2" ]]; then
        echo "‚ùå Missing FASTQ files for ${SAMPLE}, skipping..."
        continue
    fi

    echo "Using R1=${R1}, R2=${R2}"

    # ======= ËøêË°åÊØîÂØπ =======
    bowtie2 -p 10 -x ${REF_INDEX} \
        -1 ${R1} -2 ${R2} \
        -S ${SAMPLE}.sam

    # ======= ËΩ¨Êç¢Âπ∂ÊéíÂ∫è =======
    samtools view -S -b ${SAMPLE}.hg38..sam > ${SAMPLE}.hg38..bam
    samtools sort ${SAMPLE}.hg38..bam -o ${SAMPLE}.hg38..sorted.bam
    samtools index ${SAMPLE}.hg38..sorted.bam
    rm ${SAMPLE}.hg38..sam ${SAMPLE}.hg38..bam  # ËäÇÁúÅÁ©∫Èó¥

    # ======= ÁîüÊàêbigwig (not run) =======
    bamCoverage -b ${SAMPLE}.hg38..sorted.bam -o ${OUT_DIR}/${SAMPLE}.hg38.bw \
        --normalizeUsing CPM --binSize 10 --extendReads 200

    echo "‚úÖ Finished ${SAMPLE}"
done

echo "üéâ All samples processed successfully!"
########################################
unset LD_LIBRARY_PATH
module load samtools
module load deeptools/3.5.5

# ======== Ë∑ØÂæÑ ==========
BASE_DIR=/data/RichardLuLab/Eric/MTORCUTTAG
OUT_DIR=${BASE_DIR}/bw_RPGC
mkdir -p ${OUT_DIR}

# ======== Ê†∑Êú¨ÂàóË°®ÔºàÂèØÊîπÔºâ==========
for SAMPLE in A13 A14 A15 K1N K2N K3N K4N K5N
do
    BAM=${BASE_DIR}/${SAMPLE}/${SAMPLE}.hg38.sorted.bam
    BW=${OUT_DIR}/${SAMPLE}.RPGC.bw

    if [ ! -s $BAM ]; then
        echo "‚ùå Missing BAM for ${SAMPLE}, skipping..."
        continue
    fi

    echo "üöÄ Generating RPGC bigWig for ${SAMPLE}..."

    bamCoverage \
        -b $BAM \
        -o $BW \
        --binSize 10 \
        --normalizeUsing RPGC \
        --effectiveGenomeSize 2913022398 \
        --ignoreForNormalization chrX \
        --extendReads \
        --numberOfProcessors 8 \
        --verbose

    if [ -s $BW ]; then
        echo "‚úÖ Finished: ${BW}"
    else
        echo "‚ö†Ô∏è Failed for ${SAMPLE}, check log"
    fi
done

echo "üéâ All RPGC-normalized bigWigs generated!"



